# BridgeSpeak èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [èª²é‡‘ãƒ¢ãƒ‡ãƒ«](#èª²é‡‘ãƒ¢ãƒ‡ãƒ«)
3. [ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ](#ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
5. [é‡è¦ãªã‚¯ã‚¨ãƒª](#é‡è¦ãªã‚¯ã‚¨ãƒª)
6. [å®Ÿè£…ã‚¬ã‚¤ãƒ‰](#å®Ÿè£…ã‚¬ã‚¤ãƒ‰)
7. [é‹ç”¨ã‚¬ã‚¤ãƒ‰](#é‹ç”¨ã‚¬ã‚¤ãƒ‰)

---

## æ¦‚è¦

### èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ ã®ç›®çš„

BridgeSpeak ã®èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ï¼š

- âœ… **åˆ©ç›Šç‡ã®ç¢ºä¿**ï¼šLLM API ã®åŸä¾¡ã‚’ä¸Šå›ã‚‹åç›Šã‚’ä¿è¨¼
- âœ… **ã‚·ãƒ³ãƒ—ãƒ«ãªé‹ç”¨**ï¼šè¤‡é›‘ãªæ©Ÿèƒ½ã‚’æ’é™¤ã—ã€ä¿å®ˆã—ã‚„ã™ã„è¨­è¨ˆ
- âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**ï¼šæ˜ç¢ºãªæ–™é‡‘ä½“ç³»ã§å®‰å¿ƒã—ã¦åˆ©ç”¨ã§ãã‚‹
- âœ… **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**ï¼šå°†æ¥çš„ãªæ©Ÿèƒ½æ‹¡å¼µã«å¯¾å¿œå¯èƒ½

### è¨­è¨ˆæ–¹é‡

1. **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ´»ç”¨**ï¼šæ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æœ€å°é™ã«æŠ‘ãˆã‚‹
2. **ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹**ï¼šã™ã¹ã¦ã®èª²é‡‘è¨ˆç®—ã‚’ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã§çµ±ä¸€
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡**ï¼šä½¿ç”¨é‡ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¨˜éŒ²ãƒ»é›†è¨ˆ
4. **é€æ˜æ€§**ï¼šåŸä¾¡ã¨è²©å£²ä¾¡æ ¼ã‚’æ˜ç¢ºã«åˆ†é›¢ã—ã¦è¨˜éŒ²

---

## èª²é‡‘ãƒ¢ãƒ‡ãƒ«

### æ¡ç”¨ãƒ¢ãƒ‡ãƒ«ï¼šæ®µéšçš„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ + è¶…éå¾“é‡èª²é‡‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸºæœ¬æ–™é‡‘ï¼ˆæœˆé¡å›ºå®šï¼‰                              â”‚
â”‚   +                                             â”‚
â”‚ ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å†…ã¯ä½¿ã„æ”¾é¡Œ                          â”‚
â”‚   +                                             â”‚
â”‚ åˆ¶é™è¶…éæ™‚ã¯å¾“é‡èª²é‡‘                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ—ãƒ©ãƒ³æ§‹æˆ

| ãƒ—ãƒ©ãƒ³    | æœˆé¡æ–™é‡‘ | ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ | è¶…éæ–™é‡‘             | AI åˆ†èº«æ•° | åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«   |
| --------- | -------- | ------------ | -------------------- | --------- | ---------------- |
| **Free**  | 0 å††     | 100,000      | ä¸å¯ï¼ˆåˆ¶é™ã§åœæ­¢ï¼‰   | 1 ä½“      | GPT-4o-mini ã®ã¿ |
| **Basic** | 980 å††   | 1,000,000    | 0.5 å††/1000 ãƒˆãƒ¼ã‚¯ãƒ³ | 3 ä½“      | OpenAI ç³»        |
| **Pro**   | 2,980 å†† | 5,000,000    | 0.3 å††/1000 ãƒˆãƒ¼ã‚¯ãƒ³ | 10 ä½“     | ã™ã¹ã¦           |

### ãªãœã“ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸ã‚“ã ã‹ï¼Ÿ

#### ãƒ¡ãƒªãƒƒãƒˆ

1. **åç›Šã®å®‰å®šæ€§**

   - åŸºæœ¬æ–™é‡‘ã§æœ€ä½åç›Šã‚’ç¢ºä¿
   - ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¿½åŠ åç›Š

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**

   - æ¯æœˆã®äºˆç®—ãŒç«‹ã¦ã‚„ã™ã„
   - ä½¿ã„æ”¾é¡Œæ„ŸãŒã‚ã‚‹ã®ã§èºŠèº‡ãªãä½¿ãˆã‚‹
   - Free ãƒ—ãƒ©ãƒ³ã§è©¦ã›ã‚‹

3. **ãƒªã‚¹ã‚¯ç®¡ç†**

   - ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã§æš´èµ°ã‚’é˜²ã
   - è¶…éæ–™é‡‘ã§æ¥µç«¯ãªã‚³ã‚¹ãƒˆåœ§è¿«ã‚’å›é¿

4. **æˆé•·æˆ¦ç•¥**
   - Free â†’ Basic â†’ Pro ã¸ã®æ˜ç¢ºãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ‘ã‚¹

#### ä»–ã®ãƒ¢ãƒ‡ãƒ«ã¨ã®æ¯”è¼ƒ

| ãƒ¢ãƒ‡ãƒ«           | ãƒ¡ãƒªãƒƒãƒˆ           | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ                 | BridgeSpeak æ¡ç”¨ |
| ---------------- | ------------------ | -------------------------- | ---------------- |
| å®Œå…¨å¾“é‡èª²é‡‘     | å…¬å¹³ã€å‚å…¥éšœå£ä½ã„ | åç›Šä¸å®‰å®šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèºŠèº‡ | âŒ               |
| å®Œå…¨å®šé¡         | åç›Šå®‰å®šã€ä½¿ã„æ”¾é¡Œ | ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚³ã‚¹ãƒˆåœ§è¿« | âŒ               |
| **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰** | ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„     | å®Ÿè£…ã‚„ã‚„è¤‡é›‘               | âœ… **æ¡ç”¨**      |
| ãƒ—ãƒªãƒšã‚¤ãƒ‰       | å‰æ‰•ã„ã§ç¢ºå®Ÿ       | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒæ‚ªã„         | âŒ               |

---

## ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ´»ç”¨ï¼‰:
â”œâ”€â”€ usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼‰
â”œâ”€â”€ ai_agentsï¼ˆAIåˆ†èº«ï¼‰
â””â”€â”€ ai_chat_sessionsï¼ˆAIå‡¦ç†å±¥æ­´ï¼‰â† ã‚«ãƒ©ãƒ è¿½åŠ 

æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæœ€å°é™ï¼‰:
â”œâ”€â”€ llm_pricingï¼ˆLLMãƒ¢ãƒ‡ãƒ«æ–™é‡‘ãƒã‚¹ã‚¿ï¼‰
â”œâ”€â”€ subscription_plansï¼ˆãƒ—ãƒ©ãƒ³å®šç¾©ï¼‰
â””â”€â”€ user_subscriptionsï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å¥‘ç´„çŠ¶æ…‹ï¼‰
```

### 1. llm_pricingï¼ˆLLM ãƒ¢ãƒ‡ãƒ«æ–™é‡‘ãƒã‚¹ã‚¿ï¼‰

**ç›®çš„**ï¼šå„ LLM ãƒ¢ãƒ‡ãƒ«ã®åŸä¾¡ã¨è²©å£²ä¾¡æ ¼ã‚’ç®¡ç†

```sql
CREATE TABLE llm_pricing (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- ãƒ¢ãƒ‡ãƒ«è­˜åˆ¥
    provider VARCHAR(50) NOT NULL,              -- 'openai', 'anthropic', 'google'
    model VARCHAR(100) NOT NULL,                -- 'gpt-4o', 'claude-3-5-sonnet'

    -- åŸä¾¡ï¼ˆLLM APIã«æ”¯æ‰•ã†é‡‘é¡ã€1000ãƒˆãƒ¼ã‚¯ãƒ³ã‚ãŸã‚ŠUSDï¼‰
    cost_per_1k_prompt_tokens DECIMAL(10, 6) NOT NULL,
    cost_per_1k_completion_tokens DECIMAL(10, 6) NOT NULL,

    -- è²©å£²ä¾¡æ ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è«‹æ±‚ã™ã‚‹é‡‘é¡ã€1000ãƒˆãƒ¼ã‚¯ãƒ³ã‚ãŸã‚ŠUSDï¼‰
    price_per_1k_prompt_tokens DECIMAL(10, 6) NOT NULL,
    price_per_1k_completion_tokens DECIMAL(10, 6) NOT NULL,

    -- æœ‰åŠ¹ãƒ•ãƒ©ã‚°
    is_active BOOLEAN DEFAULT true,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- åˆ¶ç´„ï¼šè²©å£²ä¾¡æ ¼ã¯åŸä¾¡ä»¥ä¸Šï¼ˆåˆ©ç›Šã‚’ä¿è¨¼ï¼‰
    CONSTRAINT chk_price_above_cost CHECK (
        price_per_1k_prompt_tokens >= cost_per_1k_prompt_tokens AND
        price_per_1k_completion_tokens >= cost_per_1k_completion_tokens
    ),

    -- åŒä¸€ãƒ¢ãƒ‡ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯1ã¤ã ã‘
    CONSTRAINT unique_active_model UNIQUE(provider, model) WHERE is_active = true
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_llm_pricing_active ON llm_pricing(provider, model) WHERE is_active = true;
```

#### åˆæœŸãƒ‡ãƒ¼ã‚¿ä¾‹ï¼ˆ2024 å¹´ 12 æœˆæ™‚ç‚¹ã€åˆ©ç›Šç‡ 30%ï¼‰

```sql
INSERT INTO llm_pricing (
    provider, model,
    cost_per_1k_prompt_tokens, cost_per_1k_completion_tokens,
    price_per_1k_prompt_tokens, price_per_1k_completion_tokens
) VALUES
-- OpenAI GPT-4o
('openai', 'gpt-4o', 0.0025, 0.010, 0.00325, 0.013),
-- OpenAI GPT-4o-mini
('openai', 'gpt-4o-mini', 0.00015, 0.0006, 0.000195, 0.00078),
-- Anthropic Claude 3.5 Sonnet
('anthropic', 'claude-3-5-sonnet', 0.003, 0.015, 0.0039, 0.0195),
-- Google Gemini Pro
('google', 'gemini-pro', 0.00025, 0.0005, 0.000325, 0.00065);
```

#### é‡è¦ãƒã‚¤ãƒ³ãƒˆ

- **åŸä¾¡ã®æ›´æ–°**ï¼šLLM ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®æ–™é‡‘å¤‰æ›´æ™‚ã«æ›´æ–°
- **åˆ©ç›Šç‡ã®ç¢ºä¿**ï¼š`chk_price_above_cost`åˆ¶ç´„ã§ä¿è¨¼
- **å±¥æ­´ç®¡ç†**ï¼š`is_active`ã§éå»ã®æ–™é‡‘ã‚‚ä¿æŒï¼ˆç›£æŸ»ç”¨ï¼‰

---

### 2. subscription_plansï¼ˆãƒ—ãƒ©ãƒ³å®šç¾©ï¼‰

**ç›®çš„**ï¼šFreeã€Basicã€Pro ã® 3 ãƒ—ãƒ©ãƒ³ã‚’å®šç¾©

```sql
CREATE TABLE subscription_plans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- ãƒ—ãƒ©ãƒ³è­˜åˆ¥å­
    plan_code VARCHAR(50) UNIQUE NOT NULL,      -- 'free', 'basic', 'pro'

    -- è¡¨ç¤ºå
    name VARCHAR(100) NOT NULL,                 -- 'Free', 'Basic', 'Pro'
    description TEXT,                           -- ãƒ—ãƒ©ãƒ³ã®èª¬æ˜

    -- æ–™é‡‘ï¼ˆå††ï¼‰
    monthly_price_jpy INTEGER NOT NULL,         -- æœˆé¡æ–™é‡‘

    -- ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™
    monthly_token_limit INTEGER NOT NULL,       -- æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ï¼ˆ-1=ç„¡åˆ¶é™ï¼‰

    -- è¶…éæ–™é‡‘ï¼ˆå††/1000ãƒˆãƒ¼ã‚¯ãƒ³ã€0ãªã‚‰è¶…éä¸å¯ï¼‰
    overage_price_per_1k_tokens DECIMAL(8, 4) DEFAULT 0,

    -- æ©Ÿèƒ½åˆ¶é™
    max_ai_agents INTEGER NOT NULL DEFAULT 1,   -- ä½œæˆå¯èƒ½ãªAIåˆ†èº«æ•°
    allowed_providers TEXT[] NOT NULL DEFAULT ARRAY['openai'],  -- åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼

    -- æœ‰åŠ¹ãƒ•ãƒ©ã‚°
    is_active BOOLEAN DEFAULT true,

    -- è¡¨ç¤ºé †åº
    display_order INTEGER DEFAULT 0,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_subscription_plans_active ON subscription_plans(is_active, display_order);
```

#### åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆ3 ãƒ—ãƒ©ãƒ³ï¼‰

```sql
INSERT INTO subscription_plans (
    plan_code, name, description,
    monthly_price_jpy, monthly_token_limit, overage_price_per_1k_tokens,
    max_ai_agents, allowed_providers, display_order
) VALUES
-- Freeãƒ—ãƒ©ãƒ³
('free', 'Free', 'ç„¡æ–™ã§å§‹ã‚ã‚‹',
 0, 100000, 0,  -- è¶…éä¸å¯
 1, ARRAY['openai'], 1),

-- Basicãƒ—ãƒ©ãƒ³
('basic', 'Basic', 'å€‹äººåˆ©ç”¨å‘ã‘',
 980, 1000000, 0.5,  -- è¶…éæ™‚ï¼š1000ãƒˆãƒ¼ã‚¯ãƒ³=0.5å††
 3, ARRAY['openai'], 2),

-- Proãƒ—ãƒ©ãƒ³
('pro', 'Pro', 'ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘',
 2980, 5000000, 0.3,  -- è¶…éæ™‚ï¼š1000ãƒˆãƒ¼ã‚¯ãƒ³=0.3å††
 10, ARRAY['openai', 'anthropic', 'google'], 3);
```

#### é‡è¦ãƒã‚¤ãƒ³ãƒˆ

- **ã‚·ãƒ³ãƒ—ãƒ«**ï¼š3 ãƒ—ãƒ©ãƒ³ã®ã¿ã§ç®¡ç†ã—ã‚„ã™ã„
- **æ‹¡å¼µæ€§**ï¼šå¾Œã‹ã‚‰ Enterprise ãƒ—ãƒ©ãƒ³ã‚’è¿½åŠ å¯èƒ½
- **åˆ¶é™ç®¡ç†**ï¼šãƒ—ãƒ©ãƒ³ã”ã¨ã«æ©Ÿèƒ½åˆ¶é™ã‚’æŸ”è»Ÿã«è¨­å®š

---

### 3. user_subscriptionsï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å¥‘ç´„çŠ¶æ…‹ï¼‰

**ç›®çš„**ï¼šå„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ã®å¥‘ç´„ã¨ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¿½è·¡

```sql
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- ãƒ—ãƒ©ãƒ³
    plan_id UUID NOT NULL REFERENCES subscription_plans(id),

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    -- 'active': åˆ©ç”¨ä¸­
    -- 'cancelled': è§£ç´„æ¸ˆã¿ï¼ˆæœŸé–“çµ‚äº†ã¾ã§åˆ©ç”¨å¯èƒ½ï¼‰
    -- 'expired': æœŸé™åˆ‡ã‚Œ

    -- å¥‘ç´„æœŸé–“
    period_start TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    period_end TIMESTAMP NOT NULL,              -- ã“ã®æ—¥æ™‚ã«æ¬¡æœŸé–“ã¸æ›´æ–°

    -- ä»ŠæœŸã®ä½¿ç”¨é‡ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼‰
    tokens_used_current_period INTEGER DEFAULT 0,

    -- è§£ç´„æƒ…å ±
    cancelled_at TIMESTAMP,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT chk_subscription_status CHECK (
        status IN ('active', 'cancelled', 'expired')
    )
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_subscriptions_user ON user_subscriptions(user_id, status);
CREATE INDEX idx_user_subscriptions_period_end ON user_subscriptions(period_end)
    WHERE status = 'active';

-- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼1ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
CREATE UNIQUE INDEX unique_active_subscription ON user_subscriptions(user_id)
    WHERE status = 'active';

-- ãƒˆãƒªã‚¬ãƒ¼ï¼šupdated_atè‡ªå‹•æ›´æ–°
CREATE TRIGGER update_user_subscriptions_updated_at
    BEFORE UPDATE ON user_subscriptions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### é‡è¦ãƒã‚¤ãƒ³ãƒˆ

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½¿ç”¨é‡**ï¼š`tokens_used_current_period`ã§ç¾åœ¨ã®ä½¿ç”¨é‡ã‚’è¿½è·¡
- **æœŸé–“ç®¡ç†**ï¼š`period_end`ã§è‡ªå‹•æ›´æ–°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç®¡ç†
- **åˆ¶ç´„**ï¼š1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ 1 ã¤ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿

---

### 4. ai_chat_sessionsï¼ˆæ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µï¼‰

**ç›®çš„**ï¼šAI å‡¦ç†ã”ã¨ã®åŸä¾¡ã¨è²©å£²ä¾¡æ ¼ã‚’è¨˜éŒ²

```sql
-- æ—¢å­˜ã®ai_chat_sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE ai_chat_sessions
    -- åŸä¾¡ï¼ˆLLM APIã«æ”¯æ‰•ã†é‡‘é¡ã€USDï¼‰
    ADD COLUMN cost_usd DECIMAL(10, 6),

    -- è²©å£²ä¾¡æ ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è«‹æ±‚ã™ã‚‹é‡‘é¡ã€USDï¼‰
    ADD COLUMN price_usd DECIMAL(10, 6),

    -- ä½¿ç”¨ã—ãŸæ–™é‡‘ãƒ†ãƒ¼ãƒ–ãƒ«ã®IDï¼ˆå±¥æ­´è¿½è·¡ç”¨ï¼‰
    ADD COLUMN pricing_id UUID REFERENCES llm_pricing(id) ON DELETE SET NULL;

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON COLUMN ai_chat_sessions.cost_usd IS 'LLM APIåŸä¾¡ï¼ˆUSDï¼‰';
COMMENT ON COLUMN ai_chat_sessions.price_usd IS 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èª²é‡‘é¡ï¼ˆUSDï¼‰';
COMMENT ON COLUMN ai_chat_sessions.pricing_id IS 'é©ç”¨ã—ãŸæ–™é‡‘ãƒ†ãƒ¼ãƒ–ãƒ«ã®ID';
```

#### æ—¢å­˜ã‚«ãƒ©ãƒ ã¨ã®é–¢ä¿‚

```
ai_chat_sessionsï¼ˆæ—¢å­˜ï¼‰:
â”œâ”€â”€ user_id                      â† èª°ãŒä½¿ç”¨ã—ãŸã‹
â”œâ”€â”€ provider, model              â† ã©ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ãŸã‹
â”œâ”€â”€ tokens_prompt                â† å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°
â”œâ”€â”€ tokens_completion            â† å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°
â”œâ”€â”€ tokens_total                 â† åˆè¨ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°
â”‚
æ–°è¦è¿½åŠ :
â”œâ”€â”€ cost_usd                     â† åŸä¾¡ï¼ˆè¨ˆç®—çµæœï¼‰
â”œâ”€â”€ price_usd                    â† è²©å£²ä¾¡æ ¼ï¼ˆè¨ˆç®—çµæœï¼‰
â””â”€â”€ pricing_id                   â† ã©ã®æ–™é‡‘ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã—ãŸã‹
```

#### é‡è¦ãƒã‚¤ãƒ³ãƒˆ

- **è©³ç´°ãªè¨˜éŒ²**ï¼šã™ã¹ã¦ã® AI å‡¦ç†ã«ã¤ã„ã¦åŸä¾¡ã¨å£²ä¸Šã‚’è¨˜éŒ²
- **é›†è¨ˆå¯èƒ½**ï¼šå¾Œã‹ã‚‰ã‚³ã‚¹ãƒˆåˆ†æã‚„åˆ©ç›Šç‡è¨ˆç®—ãŒå¯èƒ½
- **ç›£æŸ»å¯¾å¿œ**ï¼š`pricing_id`ã§å½“æ™‚ã®æ–™é‡‘è¨­å®šã‚’è¿½è·¡å¯èƒ½

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    â†“
usersãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
    â†“
user_subscriptionsã«Freeãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•ä½œæˆ
    â”œâ”€â”€ plan_id: Free ãƒ—ãƒ©ãƒ³ã®ID
    â”œâ”€â”€ status: 'active'
    â”œâ”€â”€ period_start: ç¾åœ¨æ™‚åˆ»
    â”œâ”€â”€ period_end: 1ãƒ¶æœˆå¾Œ
    â””â”€â”€ tokens_used_current_period: 0
```

### 2. AI å‡¦ç†å®Ÿè¡Œæ™‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    â†“
ã€Backend-goã€‘
â”œâ”€â”€ 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
â”‚   â””â”€â”€ user_subscriptions WHERE user_id = ? AND status = 'active'
â”‚
â”œâ”€â”€ 2. ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯
â”‚   â””â”€â”€ IF tokens_used >= monthly_token_limit THEN
â”‚       â”œâ”€â”€ overage_price > 0 ãªã‚‰ç¶™ç¶šï¼ˆè¶…éèª²é‡‘ï¼‰
â”‚       â””â”€â”€ overage_price = 0 ãªã‚‰åˆ¶é™ã‚¨ãƒ©ãƒ¼
â”‚
â”œâ”€â”€ 3. ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯
â”‚   â””â”€â”€ IF provider NOT IN allowed_providers THEN ã‚¨ãƒ©ãƒ¼
â”‚
â”œâ”€â”€ 4. AIå‡¦ç†å®Ÿè¡Œï¼ˆBackend-pythonã¸ï¼‰
â”‚   â””â”€â”€ LLM APIå‘¼ã³å‡ºã— â†’ ãƒˆãƒ¼ã‚¯ãƒ³æ•°å–å¾—
â”‚
â”œâ”€â”€ 5. æ–™é‡‘è¨ˆç®—
â”‚   â”œâ”€â”€ llm_pricing ã‹ã‚‰æ–™é‡‘æƒ…å ±å–å¾—
â”‚   â”‚   â””â”€â”€ WHERE provider = ? AND model = ? AND is_active = true
â”‚   â”‚
â”‚   â”œâ”€â”€ åŸä¾¡è¨ˆç®—
â”‚   â”‚   â””â”€â”€ cost = (tokens_prompt / 1000 * cost_per_1k_prompt_tokens) +
â”‚   â”‚              (tokens_completion / 1000 * cost_per_1k_completion_tokens)
â”‚   â”‚
â”‚   â””â”€â”€ è²©å£²ä¾¡æ ¼è¨ˆç®—
â”‚       â””â”€â”€ price = (tokens_prompt / 1000 * price_per_1k_prompt_tokens) +
â”‚                   (tokens_completion / 1000 * price_per_1k_completion_tokens)
â”‚
â”œâ”€â”€ 6. ai_chat_sessionsã«è¨˜éŒ²
â”‚   â”œâ”€â”€ tokens_prompt, tokens_completion, tokens_total
â”‚   â”œâ”€â”€ cost_usd, price_usd
â”‚   â””â”€â”€ pricing_id
â”‚
â””â”€â”€ 7. user_subscriptionsã®ä½¿ç”¨é‡æ›´æ–°
    â””â”€â”€ UPDATE user_subscriptions
        SET tokens_used_current_period = tokens_used_current_period + tokens_total
        WHERE id = ?
```

### 3. æœˆæ¬¡å‡¦ç†ï¼ˆãƒãƒƒãƒï¼‰

```
ã€æ¯æ—¥å®Ÿè¡Œã™ã‚‹ãƒãƒƒãƒã€‘

æœŸé™åˆ‡ã‚Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®æ¤œå‡º
    â†“
WHERE period_end < CURRENT_TIMESTAMP AND status = 'active'
    â†“
å„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦:
    â”œâ”€â”€ cancelled_at ãŒ NULL ãªã‚‰
    â”‚   â”œâ”€â”€ æ¬¡ã®æœŸé–“ã‚’ä½œæˆ
    â”‚   â”‚   â”œâ”€â”€ period_start = æ—§period_end
    â”‚   â”‚   â”œâ”€â”€ period_end = period_start + 1ãƒ¶æœˆ
    â”‚   â”‚   â””â”€â”€ tokens_used_current_period = 0ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
    â”‚   â”‚
    â”‚   â””â”€â”€ ï¼ˆæ±ºæ¸ˆå‡¦ç†ï¼‰
    â”‚       â”œâ”€â”€ åŸºæœ¬æ–™é‡‘ï¼šmonthly_price_jpy
    â”‚       â””â”€â”€ è¶…éæ–™é‡‘ï¼štokens_overage * overage_price_per_1k_tokens / 1000
    â”‚
    â””â”€â”€ cancelled_at ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãªã‚‰
        â””â”€â”€ status = 'expired' ã«æ›´æ–°ï¼ˆã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ï¼‰
```

### 4. ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³å¤‰æ›´ã‚’ç”³è«‹
    â†“
ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã€‘
â”œâ”€â”€ å³åº§ã«æ–°ãƒ—ãƒ©ãƒ³ã«å¤‰æ›´
â”œâ”€â”€ ä½¿ç”¨é‡ã¯ãã®ã¾ã¾å¼•ãç¶™ã
â””â”€â”€ å·®é¡ã‚’æ—¥å‰²ã‚Šè¨ˆç®—ã—ã¦è«‹æ±‚ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ã€ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã€‘
â”œâ”€â”€ cancelled_at ã‚’è¨­å®š
â”œâ”€â”€ status = 'cancelled'ï¼ˆæœŸé–“çµ‚äº†ã¾ã§åˆ©ç”¨å¯èƒ½ï¼‰
â””â”€â”€ period_end æ™‚ã«æ–°ãƒ—ãƒ©ãƒ³ã§å†ä½œæˆ
```

---

## é‡è¦ãªã‚¯ã‚¨ãƒª

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ã®ä½¿ç”¨çŠ¶æ³ã‚’å–å¾—

```sql
SELECT
    u.id as user_id,
    u.email,
    u.display_name,
    sp.name as plan_name,
    sp.monthly_price_jpy,
    sp.monthly_token_limit,
    us.tokens_used_current_period,
    sp.monthly_token_limit - us.tokens_used_current_period as tokens_remaining,
    ROUND(
        (us.tokens_used_current_period::DECIMAL /
         NULLIF(sp.monthly_token_limit, 0) * 100), 2
    ) as usage_percent,
    us.period_start,
    us.period_end,
    us.status
FROM user_subscriptions us
JOIN users u ON us.user_id = u.id
JOIN subscription_plans sp ON us.plan_id = sp.id
WHERE
    us.user_id = $1 AND
    us.status = 'active';
```

**ç”¨é€”**ï¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¡¨ç¤ºã€API ãƒ¬ã‚¹ãƒãƒ³ã‚¹

---

### 2. åˆ¶é™ã«è¿‘ã¥ã„ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŠ½å‡ºï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆç”¨ï¼‰

```sql
SELECT
    u.id,
    u.email,
    sp.name as plan_name,
    us.tokens_used_current_period,
    sp.monthly_token_limit,
    ROUND(
        (us.tokens_used_current_period::DECIMAL / sp.monthly_token_limit * 100), 2
    ) as usage_percent
FROM user_subscriptions us
JOIN users u ON us.user_id = u.id
JOIN subscription_plans sp ON us.plan_id = sp.id
WHERE
    us.status = 'active' AND
    sp.monthly_token_limit > 0 AND  -- ç„¡åˆ¶é™ãƒ—ãƒ©ãƒ³ã‚’é™¤å¤–
    us.tokens_used_current_period >= sp.monthly_token_limit * 0.8  -- 80%ä»¥ä¸Š
ORDER BY usage_percent DESC;
```

**ç”¨é€”**ï¼š

- 80%é”æˆæ™‚ï¼šé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- 90%é”æˆæ™‚ï¼šè­¦å‘Šãƒ¡ãƒ¼ãƒ«é€ä¿¡
- 100%é”æˆæ™‚ï¼šåˆ¶é™é€šçŸ¥

---

### 3. ä»Šæœˆã®ã‚³ã‚¹ãƒˆãƒ»å£²ä¸Šãƒ»åˆ©ç›Šã‚’é›†è¨ˆ

```sql
SELECT
    COUNT(*) as request_count,
    SUM(tokens_total) as total_tokens,
    SUM(cost_usd) as total_cost_usd,
    SUM(price_usd) as total_revenue_usd,
    SUM(price_usd - cost_usd) as total_profit_usd,
    ROUND(
        (SUM(price_usd - cost_usd) / NULLIF(SUM(cost_usd), 0) * 100), 2
    ) as profit_margin_percent
FROM ai_chat_sessions
WHERE
    DATE_TRUNC('month', started_at) = DATE_TRUNC('month', CURRENT_TIMESTAMP) AND
    status = 'completed';
```

**ç”¨é€”**ï¼šçµŒå–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ

---

### 4. ãƒ¢ãƒ‡ãƒ«åˆ¥ã®ã‚³ã‚¹ãƒˆã¨åˆ©ç›Šã‚’åˆ†æ

```sql
SELECT
    provider,
    model,
    COUNT(*) as request_count,
    SUM(tokens_total) as total_tokens,
    ROUND(SUM(cost_usd)::NUMERIC, 4) as total_cost_usd,
    ROUND(SUM(price_usd)::NUMERIC, 4) as total_revenue_usd,
    ROUND(SUM(price_usd - cost_usd)::NUMERIC, 4) as total_profit_usd,
    ROUND(
        (SUM(price_usd - cost_usd) / NULLIF(SUM(cost_usd), 0) * 100)::NUMERIC, 2
    ) as profit_margin_percent
FROM ai_chat_sessions
WHERE
    DATE_TRUNC('month', started_at) = DATE_TRUNC('month', CURRENT_TIMESTAMP) AND
    status = 'completed'
GROUP BY provider, model
ORDER BY total_profit_usd DESC;
```

**ç”¨é€”**ï¼šã©ã®ãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç›Šç‡ãŒé«˜ã„ã‹ã‚’åˆ†æ

---

### 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®æœˆé–“ã‚³ã‚¹ãƒˆï¼ˆä¸Šä½ 100 äººï¼‰

```sql
SELECT
    u.email,
    sp.name as plan_name,
    COUNT(s.id) as request_count,
    SUM(s.tokens_total) as total_tokens,
    ROUND(SUM(s.cost_usd)::NUMERIC, 4) as total_cost_usd,
    ROUND(SUM(s.price_usd)::NUMERIC, 4) as total_revenue_usd,
    ROUND(SUM(s.price_usd - s.cost_usd)::NUMERIC, 4) as total_profit_usd
FROM ai_chat_sessions s
JOIN users u ON s.user_id = u.id
JOIN user_subscriptions us ON u.id = us.user_id AND us.status = 'active'
JOIN subscription_plans sp ON us.plan_id = sp.id
WHERE
    DATE_TRUNC('month', s.started_at) = DATE_TRUNC('month', CURRENT_TIMESTAMP) AND
    s.status = 'completed'
GROUP BY u.id, u.email, sp.name
ORDER BY total_cost_usd DESC
LIMIT 100;
```

**ç”¨é€”**ï¼šã‚³ã‚¹ãƒˆãŒã‹ã‹ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®šã€ãƒ—ãƒ©ãƒ³ææ¡ˆ

---

### 6. æœŸé™åˆ‡ã‚Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®æ¤œå‡ºï¼ˆãƒãƒƒãƒç”¨ï¼‰

```sql
SELECT
    us.id,
    us.user_id,
    u.email,
    us.period_end,
    us.cancelled_at
FROM user_subscriptions us
JOIN users u ON us.user_id = u.id
WHERE
    us.status = 'active' AND
    us.period_end < CURRENT_TIMESTAMP
ORDER BY us.period_end;
```

**ç”¨é€”**ï¼šæ—¥æ¬¡ãƒãƒƒãƒã§å®Ÿè¡Œã€æœŸé–“æ›´æ–°å‡¦ç†

---

## å®Ÿè£…ã‚¬ã‚¤ãƒ‰

### ãƒ•ã‚§ãƒ¼ã‚º 1ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

#### 1-1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```bash
# backend-go/schema/migrations/ ã«ä½œæˆ
touch 000010_create_billing_tables.up.sql
touch 000010_create_billing_tables.down.sql
```

#### 1-2. up.sql ã®å†…å®¹

```sql
-- llm_pricing ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE llm_pricing (...);

-- subscription_plans ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE subscription_plans (...);

-- user_subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE user_subscriptions (...);

-- ai_chat_sessions ã®æ‹¡å¼µ
ALTER TABLE ai_chat_sessions
    ADD COLUMN cost_usd DECIMAL(10, 6),
    ADD COLUMN price_usd DECIMAL(10, 6),
    ADD COLUMN pricing_id UUID REFERENCES llm_pricing(id) ON DELETE SET NULL;

-- åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
INSERT INTO llm_pricing (...);
INSERT INTO subscription_plans (...);
```

#### 1-3. down.sql ã®å†…å®¹ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰

```sql
-- é€†é †ã§å‰Šé™¤
ALTER TABLE ai_chat_sessions
    DROP COLUMN pricing_id,
    DROP COLUMN price_usd,
    DROP COLUMN cost_usd;

DROP TABLE IF EXISTS user_subscriptions CASCADE;
DROP TABLE IF EXISTS subscription_plans CASCADE;
DROP TABLE IF EXISTS llm_pricing CASCADE;
```

---

### ãƒ•ã‚§ãƒ¼ã‚º 2ï¼šBackend-go å®Ÿè£…

#### 2-1. ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼ˆinternal/domain/billing/ï¼‰

```go
// pricing.go
package billing

type LLMPricing struct {
    ID                            uuid.UUID
    Provider                      string
    Model                         string
    CostPer1kPromptTokens         float64
    CostPer1kCompletionTokens     float64
    PricePer1kPromptTokens        float64
    PricePer1kCompletionTokens    float64
    IsActive                      bool
}

func (p *LLMPricing) CalculateCost(promptTokens, completionTokens int) float64 {
    return (float64(promptTokens) / 1000.0 * p.CostPer1kPromptTokens) +
           (float64(completionTokens) / 1000.0 * p.CostPer1kCompletionTokens)
}

func (p *LLMPricing) CalculatePrice(promptTokens, completionTokens int) float64 {
    return (float64(promptTokens) / 1000.0 * p.PricePer1kPromptTokens) +
           (float64(completionTokens) / 1000.0 * p.PricePer1kCompletionTokens)
}
```

```go
// subscription.go
package billing

type SubscriptionPlan struct {
    ID                        uuid.UUID
    PlanCode                  string
    Name                      string
    MonthlyPriceJPY           int
    MonthlyTokenLimit         int
    OveragePricePer1kTokens   float64
    MaxAIAgents               int
    AllowedProviders          []string
}

type UserSubscription struct {
    ID                       uuid.UUID
    UserID                   uuid.UUID
    PlanID                   uuid.UUID
    Status                   string
    PeriodStart              time.Time
    PeriodEnd                time.Time
    TokensUsedCurrentPeriod  int
    CancelledAt              *time.Time
}

func (s *UserSubscription) IsOverLimit(plan *SubscriptionPlan) bool {
    if plan.MonthlyTokenLimit == -1 {
        return false // ç„¡åˆ¶é™
    }
    return s.TokensUsedCurrentPeriod >= plan.MonthlyTokenLimit
}

func (s *UserSubscription) CanUseProvider(plan *SubscriptionPlan, provider string) bool {
    for _, p := range plan.AllowedProviders {
        if p == provider {
            return true
        }
    }
    return false
}
```

#### 2-2. ãƒªãƒã‚¸ãƒˆãƒªå±¤ï¼ˆinternal/infrastructure/persistence/ï¼‰

```go
// billing_repository.go
package persistence

type BillingRepository struct {
    db *sql.DB
}

func (r *BillingRepository) GetActivePricing(ctx context.Context, provider, model string) (*billing.LLMPricing, error) {
    // SELECT ... FROM llm_pricing WHERE provider = ? AND model = ? AND is_active = true
}

func (r *BillingRepository) GetActiveSubscription(ctx context.Context, userID uuid.UUID) (*billing.UserSubscription, *billing.SubscriptionPlan, error) {
    // JOIN query to get both subscription and plan
}

func (r *BillingRepository) UpdateTokenUsage(ctx context.Context, subscriptionID uuid.UUID, tokensUsed int) error {
    // UPDATE user_subscriptions SET tokens_used_current_period = tokens_used_current_period + ?
}
```

#### 2-3. ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å±¤ï¼ˆinternal/usecase/billing/ï¼‰

```go
// billing_usecase.go
package billing

type BillingUsecase struct {
    billingRepo BillingRepository
}

// CheckAndRecordUsage AIå‡¦ç†å‰ã«åˆ¶é™ãƒã‚§ãƒƒã‚¯ã—ã€å‡¦ç†å¾Œã«è¨˜éŒ²
func (u *BillingUsecase) CheckAndRecordUsage(
    ctx context.Context,
    userID uuid.UUID,
    provider, model string,
    promptTokens, completionTokens int,
) error {
    // 1. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å–å¾—
    subscription, plan, err := u.billingRepo.GetActiveSubscription(ctx, userID)
    if err != nil {
        return err
    }

    // 2. ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¶é™ãƒã‚§ãƒƒã‚¯
    if !subscription.CanUseProvider(plan, provider) {
        return errors.New("ã“ã®ãƒ—ãƒ©ãƒ³ã§ã¯åˆ©ç”¨ã§ããªã„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ã™")
    }

    // 3. ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯
    totalTokens := promptTokens + completionTokens
    if subscription.IsOverLimit(plan) && plan.OveragePricePer1kTokens == 0 {
        return errors.New("æœˆé–“ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«é”ã—ã¾ã—ãŸ")
    }

    // 4. æ–™é‡‘æƒ…å ±å–å¾—
    pricing, err := u.billingRepo.GetActivePricing(ctx, provider, model)
    if err != nil {
        return err
    }

    // 5. ã‚³ã‚¹ãƒˆãƒ»ä¾¡æ ¼è¨ˆç®—
    cost := pricing.CalculateCost(promptTokens, completionTokens)
    price := pricing.CalculatePrice(promptTokens, completionTokens)

    // 6. ai_chat_sessionsã«è¨˜éŒ²ï¼ˆåˆ¥ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‹ã‚‰å‘¼ã°ã‚Œã‚‹æƒ³å®šï¼‰
    // 7. user_subscriptionsã®ä½¿ç”¨é‡æ›´æ–°
    if err := u.billingRepo.UpdateTokenUsage(ctx, subscription.ID, totalTokens); err != nil {
        return err
    }

    return nil
}
```

---

### ãƒ•ã‚§ãƒ¼ã‚º 3ï¼šAPI å®Ÿè£…

#### 3-1. ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å±¤ï¼ˆinternal/handler/http/ï¼‰

```go
// billing_handler.go
package http

// GET /api/v1/billing/usage/current
func (h *BillingHandler) GetCurrentUsage(c *gin.Context) {
    userID := c.GetString("user_id") // èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰å–å¾—

    usage, err := h.billingUsecase.GetCurrentUsage(ctx, userID)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }

    c.JSON(200, gin.H{
        "plan_name": usage.PlanName,
        "tokens_used": usage.TokensUsed,
        "tokens_limit": usage.TokensLimit,
        "tokens_remaining": usage.TokensRemaining,
        "usage_percent": usage.UsagePercent,
        "period_end": usage.PeriodEnd,
    })
}

// GET /api/v1/billing/plans
func (h *BillingHandler) GetPlans(c *gin.Context) {
    plans, err := h.billingUsecase.GetAllPlans(ctx)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }

    c.JSON(200, plans)
}

// POST /api/v1/billing/subscription/change
func (h *BillingHandler) ChangePlan(c *gin.Context) {
    var req struct {
        PlanCode string `json:"plan_code"`
    }

    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }

    userID := c.GetString("user_id")

    if err := h.billingUsecase.ChangePlan(ctx, userID, req.PlanCode); err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }

    c.JSON(200, gin.H{"message": "ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´ã—ã¾ã—ãŸ"})
}
```

---

### ãƒ•ã‚§ãƒ¼ã‚º 4ï¼šFrontend å®Ÿè£…

#### 4-1. ä½¿ç”¨é‡è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// components/billing/UsageDisplay.tsx
interface UsageData {
  planName: string;
  tokensUsed: number;
  tokensLimit: number;
  tokensRemaining: number;
  usagePercent: number;
  periodEnd: string;
}

export function UsageDisplay() {
  const { data } = useSWR<UsageData>("/api/v1/billing/usage/current");

  return (
    <div>
      <h3>ä»Šæœˆã®ä½¿ç”¨é‡</h3>
      <p>ãƒ—ãƒ©ãƒ³: {data?.planName}</p>
      <ProgressBar value={data?.usagePercent} />
      <p>
        {data?.tokensUsed.toLocaleString()} /{" "}
        {data?.tokensLimit.toLocaleString()} ãƒˆãƒ¼ã‚¯ãƒ³
      </p>
      <p>æ®‹ã‚Š: {data?.tokensRemaining.toLocaleString()} ãƒˆãƒ¼ã‚¯ãƒ³</p>
      <p>æ›´æ–°æ—¥: {new Date(data?.periodEnd).toLocaleDateString()}</p>
    </div>
  );
}
```

---

## é‹ç”¨ã‚¬ã‚¤ãƒ‰

### æ—¥æ¬¡ãƒãƒƒãƒå‡¦ç†

#### å®Ÿè¡Œå†…å®¹

1. **æœŸé™åˆ‡ã‚Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®æ›´æ–°**
2. **ä½¿ç”¨é‡ã‚¢ãƒ©ãƒ¼ãƒˆã®é€ä¿¡**
3. **ã‚³ã‚¹ãƒˆé›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ**

#### å®Ÿè£…ä¾‹

```go
// scripts/daily_billing_batch.go
func main() {
    // 1. æœŸé™åˆ‡ã‚Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
    expiredSubs := getExpiredSubscriptions()

    for _, sub := range expiredSubs {
        if sub.CancelledAt == nil {
            // è‡ªå‹•æ›´æ–°
            renewSubscription(sub)
        } else {
            // è§£ç´„æ¸ˆã¿ â†’ expired ã«å¤‰æ›´
            expireSubscription(sub)
        }
    }

    // 2. ä½¿ç”¨é‡ã‚¢ãƒ©ãƒ¼ãƒˆ
    highUsageUsers := getUsersNearLimit()
    for _, user := range highUsageUsers {
        sendUsageAlert(user)
    }

    // 3. æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    generateDailyReport()
}
```

### LLM æ–™é‡‘ã®æ›´æ–°æ‰‹é †

#### OpenAI ãŒæ–™é‡‘ã‚’å¤‰æ›´ã—ãŸå ´åˆ

```sql
-- 1. ç¾åœ¨ã®æ–™é‡‘ã‚’ç„¡åŠ¹åŒ–
UPDATE llm_pricing
SET is_active = false
WHERE provider = 'openai' AND model = 'gpt-4o' AND is_active = true;

-- 2. æ–°ã—ã„æ–™é‡‘ã‚’è¿½åŠ ï¼ˆåˆ©ç›Šç‡30%ã§è¨ˆç®—ï¼‰
INSERT INTO llm_pricing (
    provider, model,
    cost_per_1k_prompt_tokens, cost_per_1k_completion_tokens,
    price_per_1k_prompt_tokens, price_per_1k_completion_tokens
) VALUES (
    'openai', 'gpt-4o',
    0.0030,  -- æ–°ã—ã„åŸä¾¡
    0.012,   -- æ–°ã—ã„åŸä¾¡
    0.0039,  -- è²©å£²ä¾¡æ ¼ï¼ˆ30%å¢—ã—ï¼‰
    0.0156   -- è²©å£²ä¾¡æ ¼ï¼ˆ30%å¢—ã—ï¼‰
);
```

### ãƒ—ãƒ©ãƒ³æ–™é‡‘ã®å¤‰æ›´æ‰‹é †

#### æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ã‚’è€ƒæ…®

```sql
-- 1. æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆï¼ˆåˆ¥ã®plan_codeã§ï¼‰
INSERT INTO subscription_plans (
    plan_code, name, description,
    monthly_price_jpy, monthly_token_limit, overage_price_per_1k_tokens,
    max_ai_agents, allowed_providers, display_order
) VALUES (
    'basic_v2', 'Basic', 'å€‹äººåˆ©ç”¨å‘ã‘ï¼ˆæ–°æ–™é‡‘ï¼‰',
    1280, 1000000, 0.5,
    3, ARRAY['openai'], 2
);

-- 2. æ—§ãƒ—ãƒ©ãƒ³ã‚’éè¡¨ç¤ºã«ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç¶™ç¶šå¯èƒ½ï¼‰
UPDATE subscription_plans
SET is_visible = false
WHERE plan_code = 'basic';

-- 3. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ¬¡å›æ›´æ–°æ™‚ã«æ–°ãƒ—ãƒ©ãƒ³ã¸ç§»è¡Œ
```

### ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

#### ç›£è¦–ã™ã¹ãæŒ‡æ¨™

1. **å…¨ä½“ã®åˆ©ç›Šç‡**

   - ç›®æ¨™ï¼š30%ä»¥ä¸Š
   - ã‚¢ãƒ©ãƒ¼ãƒˆï¼š20%ã‚’ä¸‹å›ã£ãŸã‚‰é€šçŸ¥

2. **ãƒ—ãƒ©ãƒ³ã”ã¨ã®åç›Š**

   - Free ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ã‚¹ãƒˆ
   - æœ‰æ–™ãƒ—ãƒ©ãƒ³ã®åç›Š

3. **ãƒ¢ãƒ‡ãƒ«åˆ¥ã®ã‚³ã‚¹ãƒˆ**

   - ã©ã®ãƒ¢ãƒ‡ãƒ«ãŒå¤šãä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹
   - åˆ©ç›Šç‡ã®ä½ã„ãƒ¢ãƒ‡ãƒ«ã¯ãªã„ã‹

4. **ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®š**
   - ã‚³ã‚¹ãƒˆ Top100
   - ãƒ—ãƒ©ãƒ³ææ¡ˆã®è‡ªå‹•åŒ–

---

## FAQ

### Q1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã« Free ãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•ä½œæˆã™ã‚‹ã«ã¯ï¼Ÿ

```go
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ã¾ãŸã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§å®Ÿè¡Œ
func CreateUserWithFreeSubscription(ctx context.Context, user *User) error {
    tx, _ := db.BeginTx(ctx, nil)
    defer tx.Rollback()

    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    if err := createUser(tx, user); err != nil {
        return err
    }

    // 2. Freeãƒ—ãƒ©ãƒ³ã‚’å–å¾—
    freePlan, err := getPlanByCode(tx, "free")
    if err != nil {
        return err
    }

    // 3. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ
    subscription := &UserSubscription{
        UserID:      user.ID,
        PlanID:      freePlan.ID,
        Status:      "active",
        PeriodStart: time.Now(),
        PeriodEnd:   time.Now().AddDate(0, 1, 0), // 1ãƒ¶æœˆå¾Œ
        TokensUsedCurrentPeriod: 0,
    }

    if err := createSubscription(tx, subscription); err != nil {
        return err
    }

    return tx.Commit()
}
```

### Q2: è¶…éæ–™é‡‘ã¯ã©ã†è¨ˆç®—ã™ã‚‹ï¼Ÿ

```go
func CalculateOverageCost(
    plan *SubscriptionPlan,
    tokensUsed int,
) float64 {
    if plan.MonthlyTokenLimit == -1 {
        return 0 // ç„¡åˆ¶é™
    }

    overageTokens := tokensUsed - plan.MonthlyTokenLimit
    if overageTokens <= 0 {
        return 0 // åˆ¶é™å†…
    }

    // è¶…éæ–™é‡‘ = (è¶…éãƒˆãƒ¼ã‚¯ãƒ³æ•° / 1000) * è¶…éå˜ä¾¡
    return float64(overageTokens) / 1000.0 * plan.OveragePricePer1kTokens
}
```

### Q3: åˆ©ç›Šç‡ãŒä½ã„ãƒ¢ãƒ‡ãƒ«ã®ä½¿ç”¨ã‚’åˆ¶é™ã™ã‚‹ã«ã¯ï¼Ÿ

```sql
-- Freeãƒ—ãƒ©ãƒ³ã§ã¯ä½ã‚³ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ã®ã¿è¨±å¯
UPDATE subscription_plans
SET allowed_providers = ARRAY['openai']
WHERE plan_code = 'free';

-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§ã•ã‚‰ã«ç´°ã‹ãåˆ¶å¾¡
-- allowed_models: ['gpt-4o-mini'] ã®ã‚ˆã†ãªã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
```

### Q4: æ—¥å‰²ã‚Šè¨ˆç®—ã¯å¿…è¦ï¼Ÿ

**æ¨å¥¨ï¼šã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚æ—¥å‰²ã‚Šè¨ˆç®—ã¯ä¸è¦**

- ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼šå³åº§ã«åæ˜ ã€å·®é¡ã¯æ¬¡å›è«‹æ±‚æ™‚ã«èª¿æ•´
- ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼šæœŸé–“çµ‚äº†æ™‚ã«å¤‰æ›´

æ—¥å‰²ã‚ŠãŒå¿…è¦ãªå ´åˆï¼š

```go
func CalculateProration(
    oldPrice, newPrice int,
    periodStart, changeDate, periodEnd time.Time,
) int {
    totalDays := periodEnd.Sub(periodStart).Hours() / 24
    remainingDays := periodEnd.Sub(changeDate).Hours() / 24

    oldRefund := int(float64(oldPrice) * (remainingDays / totalDays))
    newCharge := int(float64(newPrice) * (remainingDays / totalDays))

    return newCharge - oldRefund
}
```

---

## ã¾ã¨ã‚

### ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã®å¼·ã¿

âœ… **ã‚·ãƒ³ãƒ—ãƒ«**ï¼šãƒ†ãƒ¼ãƒ–ãƒ« 3 ã¤è¿½åŠ ã€æ—¢å­˜ 1 ã¤æ‹¡å¼µã®ã¿  
âœ… **åˆ©ç›Šä¿è¨¼**ï¼šDB åˆ¶ç´„ã§è²©å£²ä¾¡æ ¼ â‰¥ åŸä¾¡ã‚’å¼·åˆ¶  
âœ… **é€æ˜æ€§**ï¼šåŸä¾¡ã¨å£²ä¸Šã‚’å®Œå…¨ã«åˆ†é›¢ã—ã¦è¨˜éŒ²  
âœ… **æ‹¡å¼µæ€§**ï¼šå¾Œã‹ã‚‰æ©Ÿèƒ½è¿½åŠ ãŒå®¹æ˜“  
âœ… **é‹ç”¨å®¹æ˜“**ï¼š3 ãƒ—ãƒ©ãƒ³ã®ã¿ã§ç®¡ç†ã—ã‚„ã™ã„

### å®Ÿè£…å„ªå…ˆåº¦

1. **ãƒ•ã‚§ãƒ¼ã‚º 1ï¼ˆå¿…é ˆï¼‰**ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã€åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
2. **ãƒ•ã‚§ãƒ¼ã‚º 2ï¼ˆå¿…é ˆï¼‰**ï¼šBackend-go ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ãƒªãƒã‚¸ãƒˆãƒªå±¤
3. **ãƒ•ã‚§ãƒ¼ã‚º 3ï¼ˆå¿…é ˆï¼‰**ï¼šä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯ãƒ»è¨˜éŒ²ãƒ­ã‚¸ãƒƒã‚¯
4. **ãƒ•ã‚§ãƒ¼ã‚º 4ï¼ˆæ¨å¥¨ï¼‰**ï¼šFrontend å®Ÿè£…ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
5. **ãƒ•ã‚§ãƒ¼ã‚º 5ï¼ˆå¾Œå›ã— OKï¼‰**ï¼šãƒãƒƒãƒå‡¦ç†ã€ã‚¢ãƒ©ãƒ¼ãƒˆã€æ±ºæ¸ˆé€£æº

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [DATABASE_DESIGN.md](../DATABASE_DESIGN.md) - å…¨ä½“ã® DB è¨­è¨ˆ
- [DATABASE_DESIGN_MVP.md](../DATABASE_DESIGN_MVP.md) - MVP ç‰ˆ DB è¨­è¨ˆ
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«: `backend-go/schema/migrations/`

---

**æœ€çµ‚æ›´æ–°**: 2024 å¹´ 12 æœˆ  
**ä½œæˆè€…**: AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: è¦ãƒ¬ãƒ“ãƒ¥ãƒ¼
