# ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆä¿®æ­£ã‚¬ã‚¤ãƒ‰

## ğŸ” å•é¡Œã®åŸå› 

ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆãŒå¤±æ•—ã™ã‚‹åŸå› ã¯**CORS è¨­å®šã®ä¸å‚™**ã§ã™ã€‚

### ç¾åœ¨ã®çŠ¶æ³

- **Frontend**: Vercel (ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å®Ÿè¡Œ)
- **Backend Go**: ECS (ALB çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½)
- **å•é¡Œ**: Backend Go ãŒ Vercel ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦

### æŠ€è¡“çš„ãªè©³ç´°

1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…**

   ```typescript
   // frontend/lib/actions/conversation.ts:166
   const response = await fetch(
     `${BACKEND_GO_URL}/api/v1/conversations/${conversationId}/messages`
     // ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥å®Ÿè¡Œã•ã‚Œã‚‹
   );
   ```

2. **Backend Go ã® CORS è¨­å®š**

   ```go
   // backend-go/internal/handler/http/middleware/cors.go:19
   allowedOrigins := map[string]bool{
       "http://localhost:3000":   true,
       "http://localhost:3001":   true,
       os.Getenv("FRONTEND_URL"): true,  // â† ã“ã‚ŒãŒæœªè¨­å®šã ã£ãŸ
   }
   ```

3. **ECS ã‚¿ã‚¹ã‚¯å®šç¾©**
   - `FRONTEND_URL` ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸ
   - ãã®ãŸã‚ã€Vercel ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ‹’å¦ã•ã‚Œã¦ã„ãŸ

---

## âœ… è§£æ±ºç­–

### ã‚¹ãƒ†ãƒƒãƒ— 1: Vercel ã® URL ã‚’ç¢ºèª

Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèª:

```
https://your-app.vercel.app
```

### ã‚¹ãƒ†ãƒƒãƒ— 2: Terraform ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°

`terraform/environments/prod/terraform.tfvars`:

```hcl
# Frontend URL for CORS
frontend_url = "https://your-app.vercel.app"  # å®Ÿéš›ã®URLã«å¤‰æ›´

# Allowed Origins
allowed_origins = [
  "https://neuraknot.com",
  "https://www.neuraknot.com",
  "https://your-app.vercel.app"  # å®Ÿéš›ã®URLã«å¤‰æ›´
]
```

### ã‚¹ãƒ†ãƒƒãƒ— 3: Terraform ã‚’é©ç”¨

```bash
cd terraform/environments/prod
terraform plan -var-file=terraform.tfvars -var-file=secrets.tfvars
terraform apply -var-file=terraform.tfvars -var-file=secrets.tfvars
```

### ã‚¹ãƒ†ãƒƒãƒ— 4: Vercel ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Settings â†’ Environment Variables:

```bash
BACKEND_GO_URL=http://neuraKnot-prod-alb-1183211640.ap-northeast-1.elb.amazonaws.com
```

**æ³¨æ„**: HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹å ´åˆã¯ `https://` ã‚’ä½¿ç”¨

### ã‚¹ãƒ†ãƒƒãƒ— 5: Vercel ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤

ç’°å¢ƒå¤‰æ•°å¤‰æ›´å¾Œã¯å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦:

```bash
git commit --allow-empty -m "Update environment variables"
git push origin main
```

ã¾ãŸã¯ã€Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æ‰‹å‹•ã§å†ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

---

## ğŸ§ª å‹•ä½œç¢ºèª

### 1. Backend Go ã®ãƒ­ã‚°ã‚’ç¢ºèª

```bash
aws logs tail /ecs/neuraKnot-prod-backend-go --follow --profile sso
```

æ­£å¸¸ãªå ´åˆ:

```
[GIN] 2025/10/19 - 10:00:00 | 200 | POST /api/v1/conversations/xxx/messages
```

CORS ã‚¨ãƒ©ãƒ¼ã®å ´åˆ:

```
Origin not allowed: https://your-app.vercel.app
```

### 2. ãƒ–ãƒ©ã‚¦ã‚¶ã® DevTools ã§ç¢ºèª

1. **F12** â†’ **Network** ã‚¿ãƒ–
2. ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª:
   - **Request URL**: ALB ã® URL
   - **Status**: 200 OK
   - **Response Headers**: `Access-Control-Allow-Origin` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

### 3. CORS ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª

ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª:

```
Access to fetch at 'http://...' from origin 'https://your-app.vercel.app'
has been blocked by CORS policy
```

ã“ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€Backend Go ã® CORS è¨­å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚

---

## ğŸ“Š è¨­å®šã®æµã‚Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Vercelã®ç’°å¢ƒå¤‰æ•°è¨­å®š                                   â”‚
â”‚    BACKEND_GO_URL = ALBã®URL                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Terraformã§CORSè¨­å®š                                   â”‚
â”‚    frontend_url = Vercelã®URL                           â”‚
â”‚    allowed_origins = [Vercelã®URL]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Terraform Apply                                       â”‚
â”‚    ECSã‚¿ã‚¹ã‚¯å®šç¾©ãŒæ›´æ–°ã•ã‚Œã‚‹                              â”‚
â”‚    Backend GoãŒå†èµ·å‹•ã•ã‚Œã‚‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Vercelå†ãƒ‡ãƒ—ãƒ­ã‚¤                                      â”‚
â”‚    ç’°å¢ƒå¤‰æ•°ãŒåæ˜ ã•ã‚Œã‚‹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‹•ä½œç¢ºèª                                              â”‚
â”‚    ãƒ–ãƒ©ã‚¦ã‚¶ â†’ ALB â†’ Backend Go                          â”‚
â”‚    CORSãƒã‚§ãƒƒã‚¯: OK                                      â”‚
â”‚    ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆ: å‹•ä½œ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ 1: CORS ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã—ãªã„

**åŸå› **: Backend Go ãŒå†èµ·å‹•ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:

```bash
# ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’å¼·åˆ¶æ›´æ–°
aws ecs update-service \
  --cluster neuraKnot-prod-cluster \
  --service neuraKnot-prod-backend-go \
  --force-new-deployment \
  --profile sso
```

### å•é¡Œ 2: ç’°å¢ƒå¤‰æ•°ãŒåæ˜ ã•ã‚Œãªã„

**åŸå› **: Vercel ã®å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦

**è§£æ±ºç­–**:

- Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Deployments â†’ Redeploy

### å•é¡Œ 3: HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ 503 ã‚¨ãƒ©ãƒ¼

**åŸå› **: SSL è¨¼æ˜æ›¸ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:

- ä¸€æ™‚çš„ã« HTTP ã‚’ä½¿ç”¨: `BACKEND_GO_URL=http://...`
- ã¾ãŸã¯ã€SSL è¨¼æ˜æ›¸ã‚’å–å¾—ã—ã¦ HTTPS ã‚’æœ‰åŠ¹åŒ–

### å•é¡Œ 4: Cookie ãŒé€ä¿¡ã•ã‚Œãªã„

**åŸå› **: ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã§ã® Cookie é€ä¿¡è¨­å®š

**ç¢ºèª**:

```typescript
// frontend/lib/actions/conversation.ts
fetch(url, {
  credentials: "include", // â† ã“ã‚ŒãŒå¿…è¦
  headers: {
    Cookie: `access_token=${accessToken}`,
  },
});
```

**Backend Go å´**:

```go
// backend-go/internal/handler/http/middleware/cors.go
c.Header("Access-Control-Allow-Credentials", "true")  // â† ã“ã‚ŒãŒå¿…è¦
```

---

## ğŸ“ å¤‰æ›´å†…å®¹ã®ã¾ã¨ã‚

### Terraform ãƒ•ã‚¡ã‚¤ãƒ«

1. **terraform/modules/ecs/variables.tf**

   - `frontend_url` å¤‰æ•°ã‚’è¿½åŠ 

2. **terraform/modules/ecs/main.tf**

   - Backend Go ã‚¿ã‚¹ã‚¯å®šç¾©ã« `FRONTEND_URL` ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 

3. **terraform/environments/prod/variables.tf**

   - `frontend_url` å¤‰æ•°ã‚’è¿½åŠ 

4. **terraform/environments/prod/main.tf**

   - ECS ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã« `frontend_url` ã‚’æ¸¡ã™

5. **terraform/environments/prod/terraform.tfvars**
   - `frontend_url` ã®å€¤ã‚’è¨­å®š
   - `allowed_origins` ã« Vercel URL ã‚’è¿½åŠ 

### Backend Go

å¤‰æ›´ãªã—ï¼ˆæ—¢å­˜ã® CORS è¨­å®šã‚’ä½¿ç”¨ï¼‰

### Frontend

å¤‰æ›´ãªã—ï¼ˆVercel ã®ç’°å¢ƒå¤‰æ•°ã®ã¿è¨­å®šï¼‰

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Vercel ã® URL ã‚’ç¢ºèª**
2. **terraform.tfvars ã‚’æ›´æ–°**
3. **Terraform Apply**
4. **Vercel ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š**
5. **Vercel å†ãƒ‡ãƒ—ãƒ­ã‚¤**
6. **å‹•ä½œç¢ºèª**

ã“ã‚Œã§ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã¯ãšã§ã™ï¼
